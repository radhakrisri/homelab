---
# Traefik Dashboard Deployment Tasks
# Note: K3s comes with Traefik pre-installed. This role just exposes the dashboard.

- name: Check if Traefik is installed
  kubernetes.core.k8s_info:
    kind: Deployment
    name: traefik
    namespace: "{{ traefik_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
  register: traefik_deployment
  failed_when: false

- name: Verify Traefik is installed
  ansible.builtin.assert:
    that:
      - traefik_deployment.resources | length > 0
    fail_msg: "Traefik is not installed. K3s should have Traefik pre-installed."
    success_msg: "Traefik is installed and running."

- name: Update Traefik deployment to enable dashboard
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: traefik-config
        namespace: "{{ traefik_namespace }}"
      data:
        traefik.yaml: |
          api:
            dashboard: true
            insecure: true
          
          ping:
            entryPoint: web
          
          providers:
            kubernetesCRD: {}
            kubernetesIngress: {}
          
          entryPoints:
            web:
              address: ":80"
            websecure:
              address: ":443"

- name: Patch Traefik deployment to use ConfigMap
  kubernetes.core.k8s:
    state: patched
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Deployment
    name: traefik
    namespace: "{{ traefik_namespace }}"
    definition:
      spec:
        template:
          spec:
            volumes:
              - name: config
                configMap:
                  name: traefik-config
            containers:
              - name: traefik
                volumeMounts:
                  - name: config
                    mountPath: /etc/traefik
                args:
                  - "--configFile=/etc/traefik/traefik.yaml"

- name: Create Traefik Dashboard Service
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: traefik-dashboard
        namespace: "{{ traefik_namespace }}"
        labels:
          app: traefik
          component: dashboard
      spec:
        type: "{{ traefik_dashboard_service_type }}"
        ports:
          - name: dashboard
            port: "{{ traefik_dashboard_port }}"
            targetPort: 9000
            protocol: TCP
        selector:
          app.kubernetes.io/name: traefik

- name: Create Traefik Dashboard IngressRoute (if ingress enabled)
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition:
      apiVersion: traefik.containo.us/v1alpha1
      kind: IngressRoute
      metadata:
        name: traefik-dashboard
        namespace: "{{ traefik_namespace }}"
      spec:
        entryPoints:
          - web
        routes:
          - match: "Host(`{{ traefik_dashboard_ingress_host }}`)"
            kind: Rule
            services:
              - name: api@internal
                kind: TraefikService
  when: traefik_dashboard_ingress_enabled

- name: Wait for Traefik pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ traefik_namespace }}"
    label_selectors:
      - "app.kubernetes.io/name=traefik"
    kubeconfig: "{{ kubeconfig_path }}"
  register: traefik_pods
  until: traefik_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 30
  delay: 10

- name: Display Traefik Dashboard access information
  ansible.builtin.debug:
    msg:
      - "Traefik Dashboard has been configured successfully!"
      - "Namespace: {{ traefik_namespace }}"
      - "Dashboard Port: {{ traefik_dashboard_port }}"
      - "To access Traefik Dashboard, run: kubectl port-forward -n {{ traefik_namespace }} svc/traefik-dashboard {{ traefik_dashboard_port }}:{{ traefik_dashboard_port }}"
      - "Then open http://localhost:{{ traefik_dashboard_port }}/dashboard/ in your browser"
      - "Note: The trailing slash (/) is important!"
