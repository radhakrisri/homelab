---
# Blocky DNS and Ad Blocker Deployment Tasks

- name: Pull Blocky image on controller
  command: ctr -n k8s.io images pull ghcr.io/0xerr0r/blocky:v0.28.2
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Export Blocky image to tar on controller
  command: ctr -n k8s.io images export /tmp/blocky-v0.28.2.tar ghcr.io/0xerr0r/blocky:v0.28.2
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Copy Blocky image to cluster nodes
  copy:
    src: "/tmp/blocky-v0.28.2.tar"
    dest: "/tmp/blocky-v0.28.2.tar"
  when: not ansible_check_mode

- name: Load Blocky image on cluster nodes
  command: ctr -n k8s.io images import /tmp/blocky-v0.28.2.tar
  when: not ansible_check_mode

- name: Clean up image tar file on controller
  file:
    path: "/tmp/blocky-v0.28.2.tar"
    state: absent
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Clean up image tar file on nodes
  file:
    path: "/tmp/blocky-v0.28.2.tar"
    state: absent

- name: Create namespace for Blocky
  kubernetes.core.k8s:
    name: "{{ blocky_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    validate_certs: no
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Create Blocky ConfigMap
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition: "{{ lookup('template', 'configmap.yaml.j2') }}"
    validate_certs: no
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Deploy Blocky Deployment
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    validate_certs: no
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "{{ blocky_release_name }}"
        namespace: "{{ blocky_namespace }}"
        labels:
          app: blocky
      spec:
        replicas: "{{ blocky_replicas }}"
        selector:
          matchLabels:
            app: blocky
        template:
          metadata:
            labels:
              app: blocky
          spec:
            containers:
              - name: blocky
                image: ghcr.io/0xerr0r/blocky:v0.28.2
                ports:
                  - name: dns-udp
                    containerPort: "{{ blocky_service_port }}"
                    protocol: UDP
                  - name: dns-tcp
                    containerPort: "{{ blocky_service_tcp_port }}"
                    protocol: TCP
                  - name: http
                    containerPort: "{{ blocky_api_port }}"
                    protocol: TCP
                volumeMounts:
                  - name: config
                    mountPath: /app/config.yml
                    subPath: config.yml
                resources:
                  limits:
                    cpu: "{{ blocky_cpu_limit }}"
                    memory: "{{ blocky_memory_limit }}"
                  requests:
                    cpu: "{{ blocky_cpu_request }}"
                    memory: "{{ blocky_memory_request }}"
                livenessProbe:
                  httpGet:
                    path: /
                    port: http
                  initialDelaySeconds: 10
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /
                    port: http
                  initialDelaySeconds: 5
                  periodSeconds: 5
            volumes:
              - name: config
                configMap:
                  name: "{{ blocky_release_name }}-config"
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Deploy Blocky Service
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    validate_certs: no
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ blocky_release_name }}"
        namespace: "{{ blocky_namespace }}"
        labels:
          app: blocky
      spec:
        type: "{{ blocky_service_type }}"
        ports:
          - name: dns-udp
            port: "{{ blocky_service_port }}"
            targetPort: dns-udp
            protocol: UDP
          - name: dns-tcp
            port: "{{ blocky_service_tcp_port }}"
            targetPort: dns-tcp
            protocol: TCP
          - name: http
            port: "{{ blocky_api_port }}"
            targetPort: http
            protocol: TCP
        selector:
          app: blocky
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Set default blocky_pods for check mode
  set_fact:
    blocky_pods: {"resources": []}
  when: ansible_check_mode

- name: Wait for Blocky pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ blocky_namespace }}"
    label_selectors:
      - "app=blocky"
    kubeconfig: "{{ kubeconfig_path }}"
    validate_certs: no
  register: blocky_pods
  until: blocky_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 30
  delay: 10
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Get Blocky Service details
  kubernetes.core.k8s_info:
    kind: Service
    name: "{{ blocky_release_name }}"
    namespace: "{{ blocky_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
    validate_certs: no
  register: blocky_service
  delegate_to: localhost
  run_once: true
  when: not ansible_check_mode

- name: Display Blocky access information
  ansible.builtin.debug:
    msg:
      - "Blocky DNS and Ad Blocker has been deployed successfully!"
      - "Namespace: {{ blocky_namespace }}"
      - "Service: {{ blocky_release_name }}"
      - "DNS Port: {{ blocky_service_port }}"
      - "API Port: {{ blocky_api_port }}"
      - "Configure your devices to use this DNS server"
      - "To access the API, run: kubectl port-forward -n {{ blocky_namespace }} svc/{{ blocky_release_name }} {{ blocky_api_port }}:{{ blocky_api_port }}"
  run_once: true
