# K3s Server Configuration
# Generated by Ansible - Do not edit manually

{% if k3s_server_init | default(false) %}
cluster-init: true
{% endif %}

token: "{{ k3s_token }}"

# Networking
cluster-cidr: "{{ k3s_cluster_cidr }}"
service-cidr: "{{ k3s_service_cidr }}"
cluster-dns: "{{ k3s_cluster_dns }}"

# TLS
tls-san:
  - "{{ ansible_host }}"
  - "{{ inventory_hostname }}"
{% if k3s_tls_san is defined %}
{% for san in k3s_tls_san %}
  - "{{ san }}"
{% endfor %}
{% endif %}

# Write kubeconfig with proper permissions
write-kubeconfig-mode: "{{ k3s_kubeconfig_mode }}"

# Node configuration
node-name: "{{ inventory_hostname }}"
{% if k3s_node_labels | length > 0 %}
node-label:
{% for label in k3s_node_labels %}
  - "{{ label }}"
{% endfor %}
{% endif %}

{% if k3s_node_taints | length > 0 %}
node-taint:
{% for taint in k3s_node_taints %}
  - "{{ taint }}"
{% endfor %}
{% endif %}

# Datastore (embedded etcd for HA)
{% if k3s_datastore == 'etcd' %}
# Using embedded etcd for HA
{% elif k3s_datastore_endpoint is defined %}
datastore-endpoint: "{{ k3s_datastore_endpoint }}"
{% endif %}

# Kubelet arguments
kubelet-arg:
  - "max-pods=110"
{% if ansible_architecture == 'aarch64' %}
  # ARM64 specific settings
  - "eviction-hard=memory.available<100Mi,nodefs.available<5%"
{% endif %}

{% if k3s_server_extra_args %}
# Extra arguments
{{ k3s_server_extra_args }}
{% endif %}
