---
# Ubuntu-specific tasks

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Install required packages (Ubuntu)
  ansible.builtin.apt:
    name: "{{ common_packages + debian_packages }}"
    state: present
  become: true

- name: Ensure apt-daily timers don't interfere
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
  loop:
    - apt-daily.timer
    - apt-daily-upgrade.timer
  become: true
  ignore_errors: true

# Ubuntu 24.04+ specific - handle needrestart
- name: Check if needrestart is installed
  ansible.builtin.stat:
    path: /etc/needrestart/needrestart.conf
  register: needrestart_conf

- name: Configure needrestart to automatic mode
  ansible.builtin.lineinfile:
    path: /etc/needrestart/needrestart.conf
    regexp: '^#?\$nrconf{restart}'
    line: "$nrconf{restart} = 'a';"
  become: true
  when: needrestart_conf.stat.exists
