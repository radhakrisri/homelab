---
# Authentik SSO/SAML Deployment Tasks

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - vault_authentik_secret_key is defined
      - vault_authentik_postgresql_password is defined
      - vault_authentik_secret_key != ''
      - vault_authentik_postgresql_password != ''
    fail_msg: |
      Required Authentik secrets are not set!
      Please set vault_authentik_secret_key and vault_authentik_postgresql_password in your inventory.
      Generate secure values:
        openssl rand -hex 32
      Then encrypt with Ansible Vault:
        ansible-vault encrypt_string 'your-secret-key' --name 'vault_authentik_secret_key'
        ansible-vault encrypt_string 'your-db-password' --name 'vault_authentik_postgresql_password'

- name: Create namespace for Authentik
  kubernetes.core.k8s:
    name: "{{ authentik_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: "{{ kubeconfig_path }}"

- name: Add Authentik Helm repository
  kubernetes.core.helm_repository:
    name: authentik
    repo_url: https://charts.goauthentik.io
    state: present

- name: Deploy Authentik
  kubernetes.core.helm:
    name: "{{ authentik_release_name }}"
    chart_ref: "{{ authentik_chart }}"
    chart_version: "{{ authentik_chart_version if authentik_chart_version != 'latest' else omit }}"
    release_namespace: "{{ authentik_namespace }}"
    create_namespace: true
    kubeconfig: "{{ kubeconfig_path }}"
    values:
      authentik:
        secret_key: "{{ authentik_secret_key }}"
        error_reporting:
          enabled: false
        postgresql:
          password: "{{ authentik_postgresql_password }}"
        email:
          host: "{{ authentik_email_host if authentik_email_enabled else '' }}"
          port: "{{ authentik_email_port if authentik_email_enabled else 587 }}"
          use_tls: "{{ authentik_email_use_tls }}"
          from: "{{ authentik_email_from if authentik_email_enabled else '' }}"
      
      server:
        replicas: "{{ authentik_server_replicas }}"
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
        
        service:
          type: "{{ authentik_service_type }}"
          port: "{{ authentik_service_port }}"
        
        ingress:
          enabled: "{{ authentik_ingress_enabled }}"
          hosts:
            - host: "{{ authentik_ingress_host }}"
              paths:
                - path: /
                  pathType: Prefix
      
      worker:
        replicas: "{{ authentik_worker_replicas }}"
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
      
      postgresql:
        enabled: "{{ authentik_postgresql_enabled }}"
        auth:
          username: "{{ authentik_postgresql_user }}"
          password: "{{ authentik_postgresql_password }}"
          database: "{{ authentik_postgresql_database }}"
        primary:
          persistence:
            enabled: true
            storageClass: "{{ authentik_storage_class }}"
            size: "{{ authentik_postgresql_storage_size }}"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      
      redis:
        enabled: "{{ authentik_redis_enabled }}"
        architecture: standalone
        auth:
          enabled: false
        master:
          persistence:
            enabled: true
            storageClass: "{{ authentik_storage_class }}"
            size: "{{ authentik_redis_storage_size }}"
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 250m
              memory: 256Mi
  register: authentik_deploy_result

- name: Create PVC for Authentik media
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ authentik_release_name }}-media"
        namespace: "{{ authentik_namespace }}"
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: "{{ authentik_storage_class }}"
        resources:
          requests:
            storage: "{{ authentik_storage_size }}"

- name: Wait for Authentik server pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ authentik_namespace }}"
    label_selectors:
      - "app.kubernetes.io/name=authentik"
      - "app.kubernetes.io/component=server"
    kubeconfig: "{{ kubeconfig_path }}"
  register: authentik_server_pods
  until: authentik_server_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 30
  delay: 10

- name: Wait for PostgreSQL to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ authentik_namespace }}"
    label_selectors:
      - "app.kubernetes.io/name=postgresql"
    kubeconfig: "{{ kubeconfig_path }}"
  register: postgresql_pods
  until: postgresql_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 30
  delay: 10
  when: authentik_postgresql_enabled

- name: Display Authentik access information
  ansible.builtin.debug:
    msg:
      - "Authentik SSO/SAML has been deployed successfully!"
      - "Namespace: {{ authentik_namespace }}"
      - "Release: {{ authentik_release_name }}"
      - "To access Authentik, run: kubectl port-forward -n {{ authentik_namespace }} svc/{{ authentik_release_name }}-server {{ authentik_service_port }}:{{ authentik_service_port }}"
      - "Then open http://localhost:{{ authentik_service_port }} in your browser"
      - "Default credentials: akadmin / (check Authentik documentation for initial setup)"
      - "Complete the initial setup wizard to configure your first admin user"
