---
# Reset/Uninstall K3s from all nodes
#
# WARNING: This will completely remove K3s and all cluster data!
#
# Usage:
#   ansible-playbook -i inventories/your_inventory.yaml playbooks/reset.yaml

- name: Confirm reset
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Confirm destructive action
      ansible.builtin.pause:
        prompt: |
          
          ╔══════════════════════════════════════════════════════════════╗
          ║  WARNING: This will DESTROY the K3s cluster and all data!   ║
          ║  This action is IRREVERSIBLE!                               ║
          ╚══════════════════════════════════════════════════════════════╝
          
          Press Enter to continue or Ctrl+C to abort

- name: Reset K3s agents
  hosts: k3s_agents
  gather_facts: false
  become: true
  tasks:
    - name: Check if k3s-agent-uninstall.sh exists
      ansible.builtin.stat:
        path: /usr/local/bin/k3s-agent-uninstall.sh
      register: k3s_agent_uninstall

    - name: Run K3s agent uninstall script
      ansible.builtin.command: /usr/local/bin/k3s-agent-uninstall.sh
      when: k3s_agent_uninstall.stat.exists
      ignore_errors: true

    - name: Clean up remaining K3s directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/rancher
        - /var/lib/rancher
        - /var/lib/kubelet
      ignore_errors: true

- name: Reset K3s servers
  hosts: k3s_servers
  gather_facts: false
  become: true
  tasks:
    - name: Check if k3s-uninstall.sh exists
      ansible.builtin.stat:
        path: /usr/local/bin/k3s-uninstall.sh
      register: k3s_uninstall

    - name: Run K3s uninstall script
      ansible.builtin.command: /usr/local/bin/k3s-uninstall.sh
      when: k3s_uninstall.stat.exists
      ignore_errors: true

    - name: Clean up remaining K3s directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/rancher
        - /var/lib/rancher
        - /var/lib/kubelet
        - /var/lib/etcd
      ignore_errors: true

- name: Cleanup complete
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          K3s cluster has been reset.
          All nodes have been cleaned up.
          You can now redeploy with: ansible-playbook -i inventories/your_inventory.yaml playbooks/site.yaml
