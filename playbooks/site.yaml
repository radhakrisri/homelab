---
# Main playbook for K3s HA Cluster deployment
#
# Usage:
#   ansible-playbook -i inventories/your_inventory.yaml playbooks/site.yaml
#
# For step-by-step deployment:
#   ansible-playbook -i inventories/your_inventory.yaml playbooks/site.yaml --tags common
#   ansible-playbook -i inventories/your_inventory.yaml playbooks/site.yaml --tags k3s-servers
#   ansible-playbook -i inventories/your_inventory.yaml playbooks/site.yaml --tags k3s-agents

- name: Prepare all K3s cluster nodes
  hosts: k3s_cluster
  gather_facts: true
  become: true
  tags:
    - common
    - prepare
  roles:
    - role: common

- name: Deploy K3s server nodes (control plane)
  hosts: k3s_servers
  gather_facts: true
  become: true
  serial: 1  # Deploy servers one at a time for proper HA initialization
  tags:
    - k3s
    - k3s-servers
  roles:
    - role: k3s_server

- name: Deploy K3s agent nodes (workers)
  hosts: k3s_agents
  gather_facts: true
  become: true
  tags:
    - k3s
    - k3s-agents
  roles:
    - role: k3s_agent

- name: Verify cluster status
  hosts: k3s_servers[0]
  gather_facts: false
  become: true
  tags:
    - verify
  tasks:
    - name: Wait for all nodes to be ready
      ansible.builtin.command: /usr/local/bin/k3s kubectl get nodes
      register: nodes_status
      until: nodes_status.stdout_lines | select('search', 'NotReady') | list | length == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Display cluster nodes
      ansible.builtin.debug:
        msg: "{{ nodes_status.stdout_lines }}"

    - name: Get cluster info
      ansible.builtin.command: /usr/local/bin/k3s kubectl cluster-info
      register: cluster_info
      changed_when: false

    - name: Display cluster info
      ansible.builtin.debug:
        msg: "{{ cluster_info.stdout_lines }}"

- name: Deploy K3s Services (optional)
  ansible.builtin.import_playbook: deploy-services.yaml
  when: deploy_services | default(false)
  tags:
    - services
